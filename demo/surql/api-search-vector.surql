DEFINE PARAM OVERWRITE $docs_table VALUE "topics_hnsw_cosine";

DEFINE FUNCTION OVERWRITE fn::search_vector($embedding: array<float>, $threshold: float) {
    RETURN SELECT score, texts, topic, type FROM (
        SELECT
            math::max(score) as score,
            array::group(text) as texts,
            type,
            topic
        FROM (
            SELECT
                type, actions, text, topic,
                (1 - vector::distance::knn()) AS score
            FROM type::table($docs_table)
            WHERE embedding <|50,17|> $embedding
        )
        WHERE score >= $threshold
        GROUP BY topic
    )
    ORDER BY score DESC;
};

-- TODO: why doesn't it work if I remove `get`?
DEFINE API OVERWRITE "/search-vector" FOR get, post
    MIDDLEWARE
        api::req::raw_body(false)
    THEN {
        RETURN {
            status: 200,
            body: {
                response: fn::search_vector($request.body.vector, $request.body.threshold)
            },
            headers: {
                'last-modified': time::now(),
                'expires': time::now() + 4d
            }
        };
    };

$vector = [0.016432203, 0.029809926, -0.024555465, -0.022582041, -0.03742991, -0.07055024, 0.003090937, 0.036664117, -0.019212674, 0.02485673, -0.07653566, -0.06575255, 0.07846237, 0.06489218, 0.002709837, 0.07179066, -0.058176935, 0.03117261, -0.024652893, -0.081045836, 0.04015599, -0.0007401028, -0.025602868, 0.029223237, -0.09510993, 0.039723925, 0.0154941045, 0.014090642, 0.05854606, 0.000038670736, 0.05380033, 0.027437693, 0.14340979, 0.094579235, -0.015359412, 0.02590401, 0.035715938, 0.062188793, -0.03582056, 0.0007636506, -0.0023957773, -0.004512479, 0.0036300085, 0.020291163, 0.034897305, 0.0035820121, -0.024324734, -0.0076592746, 0.01805922, 0.025731308, -0.09098705, -0.10114473, 0.005729729, 0.059531294, 0.055439897, 0.04033622, -0.062784925, -0.06839593, -0.07021303, -0.09911468, 0.020894835, -0.03957045, -0.009827862, -0.05862638, 0.00032827223, -0.025540393, -0.05580493, 0.07472133, 0.07194532, -0.05049591, -0.01511116, 0.036214806, -0.10978988, 0.0045785694, -0.07653184, -0.000967043, -0.00039618858, -0.043655455, -0.026570981, -0.03052176, -0.02500647, 0.04974242, 0.0008622334, 0.031539805, 0.058559068, -0.016611619, 0.0605955, 0.060153697, 0.04053157, 0.030175414, -0.07579075, -0.032286648, 0.011242195, -0.08484793, 0.11263397, 0.059169695, 0.07670573, -0.08782377, 0.014066636, 0.041844275, -0.024108326, 0.04385874, 0.04983588, -0.10383344, -0.016554728, 0.032529186, -0.0154741155, 0.0039444226, 0.014718592, -0.05754551, -0.087615535, 0.052339282, 0.016238676, -0.046029072, -0.015073304, 0.057566445, 0.018864002, 0.040226992, -0.093186066, 0.059743226, 0.026340814, 0.058691718, -0.025399001, 0.037174795, -0.013842048, -0.032903023, -0.017729996, -0.000000000000000000000000000000005353733, 0.024031779, 0.093234934, 0.011595048, 0.12204457, 0.047808148, 0.009757493, -0.0018034534, 0.035662543, -0.02201498, -0.027991882, -0.0053545386, 0.010588773, -0.034908317, -0.027833464, -0.053510502, -0.08464634, -0.070971414, 0.057879686, 0.018633777, 0.03852356, 0.04837307, -0.07456705, -0.09033887, 0.036578782, 0.023850294, 0.037346937, 0.0024105103, 0.042084508, 0.050184056, -0.037788738, 0.043134186, -0.00046784102, -0.0077333334, 0.03252377, -0.006591595, 0.017222937, -0.0397427, -0.03616638, 0.13676313, -0.026199432, -0.022960959, -0.023606911, -0.0026410713, -0.0091903955, 0.023638371, 0.047866195, 0.016184947, -0.018041326, 0.1042592, -0.017054157, 0.07109044, -0.043023653, 0.045865726, -0.043008603, 0.04005152, -0.020414531, -0.03554471, 0.002123286, 0.05401772, 0.08567844, -0.04583024, 0.02675924, -0.08213633, 0.13535619, 0.06440619, 0.017289696, -0.093835056, -0.047766346, 0.136718, -0.059903737, -0.029882157, 0.08176782, 0.026619636, -0.0023507052, -0.07834667, 0.02402699, -0.06452876, -0.058429476, -0.06273351, 0.0068444596, -0.086699285, -0.02246873, -0.0020979359, -0.0029729118, 0.1137613, 0.012765649, -0.01256219, 0.010516529, -0.11863553, -0.006865137, -0.024093041, 0.02562031, 0.03974132, 0.005197052, 0.095911145, 0.0000000000000000000000000000000028664343, 0.00875431, -0.018850513, -0.056044992, 0.011570572, 0.055632606, 0.03236502, -0.058602884, -0.005626639, -0.026467128, 0.025042066, 0.005248801, -0.11172808, -0.06348377, -0.082094625, -0.03590765, -0.0033143808, 0.02007818, 0.032219253, 0.025597837, 0.054744143, -0.09862783, -0.0020399585, -0.14923552, 0.06847531, 0.031793494, 0.06877843, -0.024929693, 0.004734051, -0.02198522, 0.098384805, -0.053063605, -0.1473455, -0.003658254, 0.017909184, 0.025986897, -0.024836946, -0.044217523, -0.067688115, 0.067710996, -0.029509727, 0.015899822, -0.033079866, -0.04512181, -0.08631156, -0.012987446, 0.000950011, -0.0047022235, 0.049006443, 0.01617664, -0.09105225, 0.0027038192, -0.046918593, -0.06191189, -0.06605353, 0.029081495, 0.0778471, 0.10342854, -0.034424648, -0.032825783, -0.018496577, -0.017081074, -0.038833696, 0.04410722, 0.01847982, 0.010108266, -0.01870538, -0.039302398, 0.05107846, -0.09378083, 0.00043031128, -0.08404945, 0.048231702, 0.039814707, 0.0084682945, 0.13302477, -0.06469529, 0.032769166, -0.035505004, -0.010866192, -0.02464144, -0.09806476, -0.002190758, 0.060147412, -0.03736515, 0.038983427, 0.033467997, -0.0011390661, 0.009383794, 0.010887473, 0.025851151, -0.08918609, 0.00204683, -0.025636427, 0.024617678, -0.04138408, -0.000000019762751, -0.05424559, 0.0042189313, 0.001740026, 0.0024106589, 0.0046869004, -0.045041263, -0.017359793, 0.032975446, -0.0062471526, -0.030081464, -0.029234227, -0.02578787, 0.017180478, -0.005030338, 0.10302628, 0.02370631, 0.012652418, 0.0319409, -0.031469394, -0.054805446, 0.11756143, -0.07267525, -0.002578778, 0.07058374, 0.018235227, -0.0395173, 0.02618887, 0.07936795, -0.0080608865, 0.02064215, 0.020494228, -0.043851677, -0.007823668, 0.07134806, 0.0357002, -0.059322786, 0.012246694, -0.0323123, 0.023216886, -0.031913836, 0.043430764, 0.016249351, -0.035170518, 0.028476132, 0.046961777, 0.02943866, -0.07832632, 0.022109095, -0.019321185, 0.026594426, 0.005526784, 0.08518311, 0.07641807, 0.016640175, 0.015118123, 0.05186865, 0.032219093, -0.025743764, 0.040116355, -0.082491644, 0.026324961, 0.011335699, 0.040736552, 0.052541498];

RETURN fn::search_vector($vector, 0.5);

-- Invoke:
api::invoke("/search-vector", {
    body: {"vector": $vector, "threshold": 0.5}
});
